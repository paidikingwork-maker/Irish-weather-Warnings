<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Met √âireann Weather Warnings</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #EBEDF0;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
header {
      text-align: center;
      color: #1a5276;
      margin-bottom: 30px;
    }
    header h1 {
      font-size: 2rem;
      margin-bottom: 5px;
    }
    header p {
      opacity: 0.8;
    }
    .warning-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .warning-card h2 {
      color: #1a5276;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .warning-card p {
      color: #555;
      line-height: 1.6;
    }
    .warning-card .date {
      font-size: 0.85rem;
      color: #888;
      margin-top: 10px;
    }
    .warning-card a {
      color: #2e86ab;
      text-decoration: none;
    }
    .warning-card a:hover {
      text-decoration: underline;
    }
    .no-warnings {
      background: #d4edda;
      color: #155724;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .error a {
      color: #721c24;
    }
    .loading {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      color: #555;
    }
    .refresh-btn {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background: white;
      color: #1a5276;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .refresh-btn:hover {
      background: #f0f0f0;
    }
.cache-status {
      color: #555;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    .cache-status span {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 4px;
    }
.auto-refresh {
      margin-top: 15px;
      color: #555;
      font-size: 0.9rem;
    }
    .auto-refresh label {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .auto-refresh input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .countdown {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 10px;
    }

    /* Refresh animation */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .refreshing {
      animation: pulse 0.5s ease-in-out;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        padding: 15px;
      }
      header h1 {
        font-size: 1.5rem;
      }
      header p {
        font-size: 0.9rem;
      }
      .warning-card {
        padding: 15px;
        border-radius: 8px;
      }
      .warning-card h2 {
        font-size: 1.1rem;
      }
      .refresh-btn {
        display: block;
        width: 100%;
        margin: 10px 0;
        padding: 12px 20px;
      }
      .refresh-btn + .refresh-btn,
      a.refresh-btn {
        margin-left: 0 !important;
      }
      .countdown {
        display: block;
        margin: 10px auto 0;
        width: fit-content;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üå¶Ô∏è Met √âireann Weather Warnings</h1>
      <p>Live Weather Warnings For Ireland - <span id="current-date"></span></p>
    </header>

    <!-- Temperature Display -->
    <div id="temperature-card" class="warning-card" style="text-align: center; margin-bottom: 25px; padding: 15px;">
      <div style="font-size: 0.85rem; color: #888; margin-bottom: 3px;">üìç Meta Data Centre, Clonee, Ireland</div>
      <div id="temperature" style="font-size: 2rem; font-weight: bold; color: #1a5276; display: inline;">--¬∞C</div>
      <span id="weather-condition" style="font-size: 0.95rem; color: #555; margin-left: 10px;"></span>
      <div id="weather-details" style="font-size: 0.8rem; color: #888; margin-top: 8px;"></div>
    </div>

    <h3 style="color: #1a5276; margin-bottom: 15px;">‚ö†Ô∏è Weather Warnings</h3>
    <div id="warnings">
      <div class="loading">Loading weather warnings...</div>
    </div>

    <h3 style="color: #1a5276; margin: 25px 0 15px;">üåä Marine Warnings</h3>
    <div id="marine-warnings">
      <div class="loading">Loading marine warnings...</div>
    </div>

    <div style="text-align: center;">
      <button class="refresh-btn" onclick="refreshAll()">‚Üª Refresh</button>
      <a href="https://www.met.ie/warnings-today.html" target="_blank" class="refresh-btn" style="margin-left: 10px; text-decoration: none;">üåê View Warnings</a>
      <div id="cache-status" class="cache-status"></div>
      <div class="auto-refresh">
        <span id="countdown" class="countdown"></span>
      </div>
    </div>
  </div>

  <script>
    // Fetch warnings from multiple county endpoints and merge to get all regional warnings
    const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
    const CACHE_KEY = 'met_eireann_all_warnings_v3';
    const CACHE_DURATION = 15 * 60 * 1000; // 15 minutes in milliseconds

    // All 32 Irish county codes - Republic of Ireland + Northern Ireland
    const COUNTY_CODES = [
      // Republic of Ireland (26 counties)
      'EI01', 'EI02', 'EI03', 'EI04', 'EI06', 'EI07', 'EI10', 'EI11', 'EI12', 'EI13',
      'EI14', 'EI15', 'EI16', 'EI18', 'EI19', 'EI20', 'EI21', 'EI22', 'EI23', 'EI24',
      'EI25', 'EI26', 'EI27', 'EI29', 'EI30', 'EI31',
      // Northern Ireland (6 counties)
      'EI05',  // Antrim
      'EI08',  // Armagh
      'EI09',  // Down
      'EI17',  // Fermanagh
      'EI28',  // Derry
      'tyrone' // Tyrone (no EI code found)
    ];

    // Just fetch one county to get warnings (they all return the same regional warnings that affect them)
    // Cork (EI04) is a good choice as it's often affected by Atlantic weather
    const API_URL = 'https://prodapi.met.ie/warnings/EI04';

    function getCache(key) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;

        const { data, timestamp } = JSON.parse(cached);
        const age = Date.now() - timestamp;

        if (age > CACHE_DURATION) {
          localStorage.removeItem(key);
          return null;
        }

        return { data, timestamp, age };
      } catch {
        return null;
      }
    }

    function setCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify({
          data,
          timestamp: Date.now()
        }));
      } catch {
        // localStorage might be full or disabled
      }
    }

    function updateCacheStatus(timestamp, fromCache) {
      const statusEl = document.getElementById('cache-status');
      const date = new Date(timestamp);
      const dateStr = date.toLocaleDateString('en-IE', { day: 'numeric', month: 'short', year: 'numeric' });
      const timeStr = date.toLocaleTimeString('en-IE', { hour: '2-digit', minute: '2-digit' });
      const source = fromCache ? 'cached' : 'live';
      statusEl.innerHTML = `<span>Last updated: ${dateStr} at ${timeStr} (${source})</span>`;
    }

    function getLevelColor(level) {
      const colors = {
        'Yellow': '#ffc107',
        'Orange': '#fd7e14',
        'Red': '#dc3545'
      };
      return colors[level] || '#6c757d';
    }

    function renderWarnings(warnings, containerId, noWarningsText) {
      const container = document.getElementById(containerId);

      if (!warnings || warnings.length === 0) {
        container.innerHTML = `<div class="no-warnings">‚úì ${noWarningsText}</div>`;
        return;
      }

      let html = '';
      warnings.forEach(warning => {
        const levelColor = getLevelColor(warning.level);
        // Don't show "Nil" as description
        const description = (warning.description && warning.description !== 'Nil')
          ? warning.description
          : (warning.text && warning.text !== 'Nil')
            ? warning.text
            : '';

        html += `
          <div class="warning-card" style="border-left: 5px solid ${levelColor};">
            <h2>
              <span style="background: ${levelColor}; color: ${warning.level === 'Yellow' ? '#000' : '#fff'}; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 8px;">
                ${warning.level || 'Unknown'}
              </span>
              ${escapeHtml(warning.headline || 'Weather Warning')}
            </h2>
            ${description ? `<p>${escapeHtml(description)}</p>` : ''}
            ${warning.issuedAt ? `<p class="date">Issued: ${warning.issuedAt}</p>` : ''}
            ${warning.validUntil ? `<p class="date">Valid until: ${warning.validUntil}</p>` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function fetchAllWarnings(forceRefresh = false) {
      const weatherContainer = document.getElementById('warnings');
      const marineContainer = document.getElementById('marine-warnings');

      // Check cache first (unless force refresh)
      if (!forceRefresh) {
        const cached = getCache(CACHE_KEY);
        if (cached) {
          const data = typeof cached.data === 'string' ? JSON.parse(cached.data) : cached.data;
          renderWarnings(data.national, 'warnings', 'No active weather warnings for Ireland');
          renderWarnings(data.marine, 'marine-warnings', 'No active marine warnings');
          updateCacheStatus(cached.timestamp, true);
          return;
        }
      }

      weatherContainer.innerHTML = '<div class="loading">Loading weather warnings...</div>';
      marineContainer.innerHTML = '<div class="loading">Loading marine warnings...</div>';

      try {
        // Fetch from ALL counties to ensure complete coverage of regional warnings
        const fetchPromises = COUNTY_CODES.map(code =>
          fetch(CORS_PROXY + encodeURIComponent(`https://prodapi.met.ie/warnings/${code}`))
            .then(r => r.ok ? r.json() : null)
            .catch(() => null)
        );

        const results = await Promise.all(fetchPromises);

        // Merge all warnings, deduplicating by ID
        const allNational = new Map();
        const allMarine = new Map();

        results.forEach(data => {
          if (!data || !data.warnings) return;

          // Add national warnings
          if (data.warnings.national) {
            data.warnings.national.forEach(w => {
              // Use headline as primary key since id/capId can be 0 for multiple warnings
              const key = w.headline || w.id || w.capId;
              if (!allNational.has(key)) {
                allNational.set(key, w);
              }
            });
          }

          // Add marine warnings
          if (data.warnings.marine) {
            data.warnings.marine.forEach(w => {
              // Use headline as primary key since id/capId can be 0 for multiple warnings
              const key = w.headline || w.id || w.capId;
              if (!allMarine.has(key)) {
                allMarine.set(key, w);
              }
            });
          }
        });

        const mergedData = {
          national: Array.from(allNational.values()),
          marine: Array.from(allMarine.values())
        };

        // Cache the merged response
        setCache(CACHE_KEY, mergedData);

        // Render warnings
        renderWarnings(mergedData.national, 'warnings', 'No active weather warnings for Ireland');
        renderWarnings(mergedData.marine, 'marine-warnings', 'No active marine warnings');
        updateCacheStatus(Date.now(), false);

      } catch (error) {
        console.error('Error fetching warnings:', error);

        // Try to show stale cache on error
        const staleCache = localStorage.getItem(CACHE_KEY);
        if (staleCache) {
          const { data, timestamp } = JSON.parse(staleCache);
          const warningData = JSON.parse(data);
          renderWarnings(warningData.warnings.national, 'warnings', 'No active weather warnings for Ireland');
          renderWarnings(warningData.warnings.marine, 'marine-warnings', 'No active marine warnings');
          const statusEl = document.getElementById('cache-status');
          statusEl.innerHTML += ' <span style="color: #dc3545;">(offline)</span>';
          return;
        }

        weatherContainer.innerHTML = `
          <div class="error">
            <p>Unable to load weather warnings.</p>
            <p style="margin-top: 10px;">
              <a href="https://www.met.ie/warnings-today" target="_blank">View warnings on Met.ie ‚Üí</a>
            </p>
          </div>
        `;
        marineContainer.innerHTML = `
          <div class="error">
            <p>Unable to load marine warnings.</p>
            <p style="margin-top: 10px;">
              <a href="https://www.met.ie/marine-inland-lakes/warnings" target="_blank">View marine warnings on Met.ie ‚Üí</a>
            </p>
          </div>
        `;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    fetchAllWarnings();

    // Fetch temperature - try Met √âireann first, fallback to Open-Meteo
    const MET_EIREANN_WEATHER_API = 'https://prodapi.metweb.ie/observations/dublin/today';
    const OPEN_METEO_API = 'https://api.open-meteo.com/v1/forecast?latitude=53.4167&longitude=-6.45&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=Europe%2FDublin';

    async function fetchTemperature() {
      // Show loading state
      document.getElementById('temperature').textContent = '...';
      document.getElementById('weather-condition').textContent = '';
      document.getElementById('weather-details').textContent = 'Loading...';

      // Try Met √âireann first
      try {
        const response = await fetch(CORS_PROXY + encodeURIComponent(MET_EIREANN_WEATHER_API));
        if (!response.ok) throw new Error('Met √âireann API error');

        const data = await response.json();
        const latest = data[data.length - 1];

        if (!latest) throw new Error('No weather data available');

        document.getElementById('temperature').textContent = `${latest.temperature}¬∞C`;

        const condition = latest.weatherDescription !== 'N/A' && latest.weatherDescription
          ? getWeatherEmoji(latest.weatherDescription) + ' ' + latest.weatherDescription
          : '';
        document.getElementById('weather-condition').textContent = condition;

        document.getElementById('weather-details').innerHTML =
          `üí® Wind: ${latest.windSpeed} km/h ${latest.cardinalWindDirection}  |  üíß Humidity: ${latest.humidity.trim()}%<br>
           <span style="font-size: 0.8rem; color: #aaa;">Dublin Airport ¬∑ ${latest.reportTime}</span>`;
        return;
      } catch (error) {
        console.error('Met √âireann error:', error);
      }

      // Fallback to Open-Meteo
      try {
        const response = await fetch(OPEN_METEO_API);
        if (!response.ok) throw new Error('Open-Meteo API error');

        const data = await response.json();
        const current = data.current;

        document.getElementById('temperature').textContent = `${Math.round(current.temperature_2m)}¬∞C`;
        document.getElementById('weather-condition').textContent = getWeatherCodeDescription(current.weather_code);
        document.getElementById('weather-details').innerHTML =
          `üí® Wind: ${Math.round(current.wind_speed_10m)} km/h  |  üíß Humidity: ${current.relative_humidity_2m}%<br>
           <span style="font-size: 0.8rem; color: #aaa;">Clonee area ¬∑ Live</span>`;
        return;
      } catch (error) {
        console.error('Open-Meteo error:', error);
      }

      // Fallback: show error with link
      document.getElementById('temperature').textContent = '--¬∞C';
      document.getElementById('weather-condition').textContent = '';
      document.getElementById('weather-details').innerHTML =
        '<a href="https://www.met.ie/weather-forecast/clonee-meath" target="_blank" style="color: #2e86ab;">View on Met.ie ‚Üí</a>';
    }

    function getWeatherCodeDescription(code) {
      const descriptions = {
        0: '‚òÄÔ∏è Clear sky',
        1: 'üå§Ô∏è Mainly clear',
        2: '‚õÖ Partly cloudy',
        3: '‚òÅÔ∏è Overcast',
        45: 'üå´Ô∏è Foggy',
        48: 'üå´Ô∏è Rime fog',
        51: 'üåßÔ∏è Light drizzle',
        53: 'üåßÔ∏è Drizzle',
        55: 'üåßÔ∏è Dense drizzle',
        61: 'üåßÔ∏è Slight rain',
        63: 'üåßÔ∏è Moderate rain',
        65: 'üåßÔ∏è Heavy rain',
        71: 'üå®Ô∏è Slight snow',
        73: 'üå®Ô∏è Moderate snow',
        75: 'üå®Ô∏è Heavy snow',
        80: 'üå¶Ô∏è Rain showers',
        81: 'üå¶Ô∏è Moderate showers',
        82: 'üå¶Ô∏è Heavy showers',
        95: '‚õàÔ∏è Thunderstorm',
        96: '‚õàÔ∏è Thunderstorm with hail',
        99: '‚õàÔ∏è Heavy thunderstorm'
      };
      return descriptions[code] || 'üå§Ô∏è Unknown';
    }

    function getWeatherEmoji(description) {
      const desc = description.toLowerCase();
      if (desc.includes('rain') || desc.includes('drizzle') || desc.includes('showers')) return 'üåßÔ∏è';
      if (desc.includes('thunder')) return '‚õàÔ∏è';
      if (desc.includes('snow') || desc.includes('sleet')) return 'üå®Ô∏è';
      if (desc.includes('fog') || desc.includes('mist')) return 'üå´Ô∏è';
      if (desc.includes('cloud') || desc.includes('overcast')) return '‚òÅÔ∏è';
      if (desc.includes('fair') || desc.includes('partly')) return '‚õÖ';
      if (desc.includes('clear') || desc.includes('sun')) return '‚òÄÔ∏è';
      return 'üå§Ô∏è';
    }

    fetchTemperature();

    // Update current date in header
    function updateCurrentDate() {
      const dateEl = document.getElementById('current-date');
      const now = new Date();
      dateEl.textContent = now.toLocaleDateString('en-IE', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
    }
    updateCurrentDate();

    // Auto-refresh functionality
    const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
    let autoRefreshTimer = null;
    let countdownTimer = null;
    let secondsRemaining = 0;

    function startAutoRefresh() {
      secondsRemaining = AUTO_REFRESH_INTERVAL / 1000;
      updateCountdown();

      countdownTimer = setInterval(() => {
        secondsRemaining--;
        updateCountdown();
      }, 1000);

      autoRefreshTimer = setInterval(() => {
        refreshAll();
        secondsRemaining = AUTO_REFRESH_INTERVAL / 1000;
      }, AUTO_REFRESH_INTERVAL);
    }

    function updateCountdown() {
      const countdownEl = document.getElementById('countdown');
      const minutes = Math.floor(secondsRemaining / 60);
      const seconds = secondsRemaining % 60;
      countdownEl.textContent = `Next update: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // Start auto-refresh automatically
    document.getElementById('countdown').style.display = 'inline';
    startAutoRefresh();

    // Unified refresh function with visual feedback
    async function refreshAll() {
      const tempCard = document.getElementById('temperature-card');
      const warningsDiv = document.getElementById('warnings');
      const marineDiv = document.getElementById('marine-warnings');

      // Add visual pulse animation
      tempCard.classList.add('refreshing');
      warningsDiv.classList.add('refreshing');
      marineDiv.classList.add('refreshing');

      // Show loading states
      document.getElementById('temperature').textContent = '...';
      document.getElementById('weather-condition').textContent = '';
      document.getElementById('weather-details').textContent = 'Loading...';
      warningsDiv.innerHTML = '<div class="loading">Loading weather warnings...</div>';
      marineDiv.innerHTML = '<div class="loading">Loading marine warnings...</div>';

      // Small delay to ensure loading state is visible
      await new Promise(resolve => setTimeout(resolve, 300));

      // Fetch all data
      await Promise.all([
        fetchAllWarnings(true),
        fetchTemperature()
      ]);

      // Remove animation after completion
      setTimeout(() => {
        tempCard.classList.remove('refreshing');
        warningsDiv.classList.remove('refreshing');
        marineDiv.classList.remove('refreshing');
      }, 500);
    }
  </script>
</body>
</html>
